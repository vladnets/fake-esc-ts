(()=>{"use strict";var t={694:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Entity=void 0,e.Entity=class{constructor(t,e=null,n=-1){this.id=t,this.container=e,this.index=n}}},406:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.EntityContainer=void 0,e.EntityContainer=class{constructor(t,e,n){this.sign=t,this.types=e,this.typeManager=n,this.count=0,this.entities=[],this.components=[],this.types.forEach((t=>{if(this[t.id])return;const e=[];this.components.push(e),this[t.id]=e}))}addEntity(t,e,n){const s=this.count;return s<this.entities.length?(this.entities[s]=t,e.forEach(((t,e)=>{this[t.id]&&(this[t.id][s]=n[e])}))):(this.entities.push(t),e.forEach(((t,e)=>{this[t.id]&&this[t.id].push(n[e])}))),t.index=s,t.container=this,this.count++,s}removeEntity(t){const e=this.count-1;let n;return n=t.index===e?this._removeLast():this._swapWithLast(t.index),t.index=-1,t.container=null,this.count--,n}getComponent(t){return this[this.typeManager.getType(t).id]}_removeLast(){const t=this.count-1;this.entities[t]=null;const e=[],n=this.types.length;for(let s=0;s<n;s++){const n=this.components[s];e.push(n[t]),n[t]=null}return e}_swapWithLast(t){const e=this.count-1,n=this.entities[e];this.entities[t]=n,this.entities[e]=null;const s=[],i=this.types.length;for(let n=0;n<i;n++){const i=this.components[n];s.push(i[t]),i[t]=i[e],i[e]=null}return n.index=t,s}}},751:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.EntityContainerManager=void 0;const s=n(406);e.EntityContainerManager=class{constructor(t){this.typeManager=t,this.signManager=this.typeManager.signManager,this.containers=[],this.containersMap={},this._init()}create(t,e){const n=new s.EntityContainer(t,e,this.typeManager);return this.addContainer(n),n}addContainer(t){let e=this.containersMap;const n=t.sign;for(let t=0;t<n.parts.length-1;t++){const s=n.parts[t];e[s]||(e[s]={}),e=e[s]}this.containers.push(t),e[n.parts[n.parts.length-1]]=t}getContainer(t){let e=this.containersMap;for(let n=0;n<t.parts.length;n++){const s=t.parts[n];if(!e[s])return;e=e[s]}return e}_init(){}}},265:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.EntityManager=void 0;const s=n(751),i=n(402),r=n(951),o=n(661);e.EntityManager=class{constructor(t){this._entities=[],this._entitiesPool=[],this._queries=[],this._typeManager=t,this._signManager=t.signManager,this._containerManager=new s.EntityContainerManager(this._typeManager);const e={entities:this._entities,entitiesPool:this._entitiesPool,queries:this._queries,typeManager:this._typeManager,signManager:this._signManager,containerManager:this._containerManager};this._entityExt=new i.EntityExtension(e),this._componentsExt=new r.ComponentsExtension(e),this._queryExt=new o.QueryExtension(e)}registerComponent(t){this._typeManager.register(t)}createEntity(...t){return this._entityExt.createEntity(t)}removeEntity(t){this._entityExt.removeEntity(t)}setComponents(t,...e){this._componentsExt.setComponents(t,e)}removeComponents(t,...e){this._componentsExt.removeComponents(t,e)}createQuery(t,e){return this._queryExt.createQuery(t,e)}}},38:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.EntityQuery=void 0,e.EntityQuery=class{constructor(t,e){this.includeSign=t,this.excludeSign=e,this.containers=[]}tryAddContainer(t){return!(!t.sign.includes(this.includeSign)||!t.sign.excludes(this.excludeSign)||(this.containers.push(t),0))}}},35:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Sign=void 0;class n{constructor(t){this.parts=t}includes(t){return this.parts.every(((e,n)=>{const s=t.parts[n];return(e&s)===s}))}excludes(t){return this.parts.every(((e,n)=>0==(e&t.parts[n])))}clone(){return new n([...this.parts])}addTypes(t){t.forEach((t=>{t.sign.parts.forEach(((t,e)=>{const n=this.parts[e]&t;this.parts[e]+=t-n}))}))}}e.Sign=n},767:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.SignManager=void 0;const s=n(35);e.SignManager=class{constructor(t){this.signPartsCount=t}createEmpty(){const t=[],e=this.signPartsCount;for(let n=0;n<e;n++)t.push(0);return new s.Sign(t)}createFromTypes(t){const e=this.createEmpty();return e.addTypes(t),e}}},111:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Type=void 0,e.Type=class{constructor(t,e){this.id=t,this.sign=e}}},663:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.TypeManager=void 0;const s=n(111);e.TypeManager=class{constructor(t){this.registry=new WeakMap,this.signManager=t,this.nextId=0,this.nextPart=2,this.nextPartIndex=0,this.halfMaxPart=Math.pow(2,30)/2}getType(t){return this.registry.get(t)}register(t){const e=this.registry.get(t);if(e)return e;const n=this.signManager.createEmpty();n.parts[this.nextPartIndex]=this.nextPart;const i=new s.Type(this.nextId,n);return this.registry.set(t,i),this.nextPart>this.halfMaxPart?(this.nextPart=2,this.nextPartIndex++):this.nextPart*=2,this.nextId++,i}}},951:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ComponentsExtension=void 0;const s=n(259);class i extends s.ExtensionBase{setComponents(t,e){const n=this.entities[t],s=n.container,i=[...this._getTypesFromValues(e),...s.types],r=this.signManager.createFromTypes(i),o=this._findOrCreateContainer(r,i),a=s.removeEntity(n),c=[...e,...a];o.addEntity(n,i,c)}removeComponents(t,e){const n=this.entities[t],s=n.container,i=this._getTypesFromConstructors(e),r=s.types,o=r.filter((t=>!i.includes(t))),a=this.signManager.createFromTypes(o),c=this._findOrCreateContainer(a,o),h=s.removeEntity(n);c.addEntity||console.log(a,o,this),c.addEntity(n,r,h)}}e.ComponentsExtension=i},402:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.EntityExtension=void 0;const s=n(694),i=n(259);class r extends i.ExtensionBase{createEntity(t){const e=this._createOrReuseEntity(),n=this._getTypesFromValues(t),s=this.signManager.createFromTypes(n);return this._findOrCreateContainer(s,n).addEntity(e,n,t),e.id}removeEntity(t){const e=this.entities[t];e.container.removeEntity(e),this.entitiesPool.push(e)}_createOrReuseEntity(){let t;return this.entitiesPool.length>0?t=this.entitiesPool.pop():(t=new s.Entity(this.entities.length),this.entities.push(t)),t}}e.EntityExtension=r},259:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ExtensionBase=void 0,e.ExtensionBase=class{constructor(t){this.entities=t.entities,this.entitiesPool=t.entitiesPool,this.queries=t.queries,this.typeManager=t.typeManager,this.signManager=t.signManager,this.containerManager=t.containerManager}_findOrCreateContainer(t,e){return this.containerManager.getContainer(t)||this._createContainer(t,e)}_createContainer(t,e){const n=this.containerManager.create(t,e);return this.queries.forEach((t=>t.tryAddContainer(n))),n}_getTypesFromValues(t){return t.map((t=>this.typeManager.getType(t.constructor)))}_getTypesFromConstructors(t){return t.map((t=>this.typeManager.getType(t)))}}},661:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.QueryExtension=void 0;const s=n(259),i=n(38);class r extends s.ExtensionBase{createQuery(t,e){const n=this._getTypesFromConstructors(t),s=this._getTypesFromConstructors(e),r=this.signManager.createFromTypes(n),o=this.signManager.createFromTypes(s),a=new i.EntityQuery(r,o);return this.queries.push(a),this.containerManager.containers.forEach((t=>a.tryAddContainer(t))),a}}e.QueryExtension=r},127:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0});const s=n(265),i=n(767),r=n(663),o=window.ENTITIES_COUNT||1e4;class a{constructor(t,e,n,s=!1){this.source=t,this.target=e,this.speed=n,this.isDone=s}}class c{}class h{constructor(t){this.speed=t}}const u=new i.SignManager(2),p=new r.TypeManager(u),y=new s.EntityManager(p);y.registerComponent(a),y.registerComponent(h),y.registerComponent(c);const g=document.querySelector("#text"),d=y.createQuery([h],[a]),l=y.createQuery([a],[c]),E=y.createQuery([a,c],[]);let _=0,M=0,m=Date.now();const x=()=>{d.containers.forEach((t=>{const e=t.getComponent(h);for(let n=0;n<t.count;n++){const s=t.entities[n],i=e[n];y.setComponents(s.id,new a(0,1,i.speed))}})),l.containers.forEach((t=>{const e=t.getComponent(a);for(let n=0;n<t.count;n++){const s=t.entities[n],i=e[n];i.speed-=.05,M+=i.speed,i.speed<=0&&(i.isDone=!0,y.setComponents(s.id,new c))}})),E.containers.forEach((t=>{const e=t.getComponent(a);for(let n=0;n<t.count;n++){const s=t.entities[n],i=e[n];i.source=1,i.target=0,i.speed=1,i.isDone=!1,y.removeComponents(s.id,c)}})),_++;const t=Date.now();t-m>=1e3&&(m=t,console.log(_),g.innerHTML=`update ${o} entities in ${_}`,M=0,_=0),requestAnimationFrame(x)};(()=>{for(let t=0;t<o;t++)y.createEntity(new h(1))})(),x(),window.update=x}},e={};!function n(s){var i=e[s];if(void 0!==i)return i.exports;var r=e[s]={exports:{}};return t[s](r,r.exports,n),r.exports}(127)})();
//# sourceMappingURL=index.bb7ddd8f06698dc7ca09.js.map